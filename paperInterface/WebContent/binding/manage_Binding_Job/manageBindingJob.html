<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
  <title>Manage Binding Job</title>
  <link rel="shortcut icon" href="#">
  <link rel="stylesheet" href="../../syles.css">
  <style>
    body{
      margin: 0%;
      padding: 0%;
    }
    .bdy    {  
          font-family: 'Montserrat', sans-serif;  
          text-align: center;  
          background-color: rgb(63,72,83);  
          font-family: sans-serif;  
          color: rgb(5, 5, 5);  
          overflow-x: hidden;  
        } 
    * {
          box-sizing: border-box;
     }
     .tble{
    font-family: 'Montserrat', sans-serif;  
      text-align: center;  
      background-color: rgb(63,72,83);  
      font-family: sans-serif;
      color: rgb(5, 5, 5);
      overflow-x: hidden; 
}
.topnav {
  overflow: hidden;
  background-color: #333;
}

.topnav a {
  float: left;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 20px;
}

.topnav a:hover {
  background-color: #ddd;
  color: black;
}

.topnav a.active {
  background-color: #03e9f4;
  color: black;

}   
</style>
</head>
<body>
<div class="topnav">
    <a href="http://localhost:8080/paperInterface/home/homepage.html">Home</a>
    <a href="http://localhost:8080/paperInterface/home/Inventory.html">Inventory</a>
    <a href="http://localhost:8080/paperInterface/purchasing/purchases.html">Purchases</a>
    <a href="http://localhost:8080/paperInterface/printing/Printing.html">Printing Job</a>
    <a href="http://localhost:8080/paperInterface/compiling/Compiling.html">Compiling Job</a>
    <a class="active" href="http://localhost:8080/paperInterface/binding/Binding.html">Binding Job</a>
    <a href="#about">About</a>
</div>
<div class="bdy">
<div class="user-box">
  <div class="RepoBtns">
    <button class = 'btn' type="button" onclick="history.back()">BACK</button>
</div>
<h1 class="head1">Manage Binding Jobs</h1>
  <br>
  <br>
  <select id="Category" onchange="getBindingJobs()">
    <option value="0">Select a category</option>
        <option value="1">Paper</option>
        <option value="2">Title Card</option>
        <option value="3">Separator Card</option>
</select>
</div>      
<div class="tble">
<h1 class="head1">Binding Jobs</h1>
<table class="tableData" id="myTable">  
  <thead>  
    <tr>  
      <th> ID </th>
      <th> Size </th>  
      <th> Weight </th>  
      <th> Purchase Vendor </th>
      <th> Printing Vendor </th>  
      <th> Compiling Vendor </th>  
      <th> Binding Vendor </th>  
      <th> Total Quantity</th>
      <th> Receive Quantity</th>
      <th> Remaining Quantity</th>
      <th> Status </th>  
    </tr>   
  </thead> 
  <tbody id = "receivebindingJob"> </tbody>  
  
</table>
 <div class="loginPopup">
  <div class="formPopup" id="popupForm">
  </div>
</div>
<label class="lbl" hidden="hidden">Please Insert Valid Quantity!</label>
</div>
</div>
</body>
<script type="text/javascript">

var parseXML;
if (typeof window.DOMParser != "undefined") {
 parseXML = function(xmlStr) {
 return ( new window.DOMParser() ).parseFromString(xmlStr, "text/xml");
 };
} else if (typeof window.ActiveXObject != "undefined" &&
 new window.ActiveXObject("Microsoft.XMLDOM")) {
 parseXML = function(xmlStr) {
 var xmlDoc = new window.ActiveXObject("Microsoft.XMLDOM");
 xmlDoc.async = "false";
 xmlDoc.loadXML(xmlStr);
 return xmlDoc;
 };
} else {
 throw new Error("No XML parser found");
}

window.onload = (e) =>{
	console.log("Page has been loaded");
}
function removeRows() {
      var table = document.getElementById("receivebindingJob");
      var rowCount = table.rows.length;
      // Start from the last row to avoid issues with changing indices.
      for (var i = rowCount - 1; i >= 0; i--) {
        table.deleteRow(i);
      }
      table.innerHTML = table.innerHTML.replace(/<br>/g, "");
    }

function getBindingJobs(){
  removeRows();
    var category = document.getElementById('Category').value
    var myHeaders = new Headers();
myHeaders.append("SOAPAction", "\"\"");
myHeaders.append("Content-Type", "application/xml");

var raw = `<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
    <Body>
        <manageBindingJob xmlns="http://manage_binding_job">
            <category>${category}</category>
        </manageBindingJob>
    </Body>
</Envelope>`

var requestOptions = {
  method: 'POST',
  headers: myHeaders,
  body: raw,
  redirect: 'follow'
};

fetch("http://localhost:8080/paper/services/ManageBindingingJob", requestOptions)
  .then(response => response.text())
  .then(result =>  {
			
		  var xml = parseXML(result);
		  var tbody = document.getElementById('receivebindingJob');
		  var numberOfRecords = xml.getElementsByTagName('manageBindingJobReturn').length;
		
		  for(i = 0; i < numberOfRecords; i++){

          var bindId = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[0].childNodes[0].nodeValue;
          var compileId = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[1].childNodes[0].nodeValue;
					var size = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[2].childNodes[0].nodeValue;
					var weight = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[3].childNodes[0].nodeValue;
					var vendor = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[4].childNodes[0].nodeValue;
					var printvendor = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[5].childNodes[0].nodeValue;
          var compilevendor = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[6].childNodes[0].nodeValue;
          var bindvendor = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[7].childNodes[0].nodeValue;
          var total_Quan = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[8].childNodes[0].nodeValue;
          var receive_Quan = xml.getElementsByTagName('manageBindingJobReturn')[i].childNodes[9].childNodes[0].nodeValue;
          var remain_Quan = total_Quan - receive_Quan;

					additem(bindId,compileId,size,weight,vendor,printvendor,compilevendor,bindvendor,total_Quan,receive_Quan,remain_Quan,bindId);
          
		  }
	  })
  .catch(error => console.log('error', error));
}

function additem(bindId,compileId,size,weight,vendor,printvendor,compilevendor,bindvendor,total_Quan,receive_Quan,remain_Quan,bindId){

  var tbody = document.getElementById('receivebindingJob');

  let br = document.createElement("br");
  let br1 = document.createElement('br');
  let br2 = document.createElement('br');

	let trow=document.createElement("tr");
	let td1=document.createElement('td');
	let td2=document.createElement('td');
	let td3=document.createElement('td');
	let td4=document.createElement('td');
	let td5=document.createElement('td');
	let td6=document.createElement('td');
  let td7=document.createElement('td');
	let td8=document.createElement('td');
	let td9=document.createElement('td');
  let td10=document.createElement('td');
  let td11=document.createElement('td');
  let td12=document.createElement('td');
  
	td1.innerHTML="BIN"+bindId;
  td2.innerHTML=size;
	td3.innerHTML=weight;
	td4.innerHTML=vendor;
	td5.innerHTML=printvendor;
  td6.innerHTML=compilevendor;
  td7.innerHTML=bindvendor;
  td8.innerHTML=total_Quan;
  td8.setAttribute("id", "qua"  + bindId);
	td9.innerHTML=receive_Quan;
  td9.setAttribute("id", "rec"  + bindId);
	td10.innerHTML=remain_Quan;
  td10.setAttribute("id", "rem"  + bindId);
  
	trow.appendChild(td1);
	trow.appendChild(td2);
	trow.appendChild(td3);
	trow.appendChild(td4);
	trow.appendChild(td5);
	trow.appendChild(td6);
  trow.appendChild(td7);
	trow.appendChild(td8);
	trow.appendChild(td9);
	trow.appendChild(td10);

    var buttonText;

if(remain_Quan == 0)
{
  td11.innerHTML = "COMPLETED!";
  td11.setAttribute("style", "color: #26c406;");
  td11.style.fontWeight= "bold"
}

else
{  if (remain_Quan < total_Quan)
  {
    buttonText = "Receive More";
  }
 else
  {
    buttonText = "Receive";
  }

  let tdbutton = document.createElement('button');
  tdbutton.innerText = buttonText;
  tdbutton.setAttribute("id","rcv" + bindId);
  tdbutton.setAttribute("onCLick", "openForm(this.id)");
  tdbutton.setAttribute("style", "background-color: #26c406;");
  tdbutton.setAttribute("class", "edit");
  td11.appendChild(tdbutton);
}

    let tdbutton2 = document.createElement('button');
    tdbutton2.innerText ="View History";
    tdbutton2.setAttribute("id","vhs" + bindId);
    tdbutton2.setAttribute("onCLick", "redirect(this.id)");
    tdbutton2.setAttribute("style", "background-color: #cf7d11;");
    tdbutton2.setAttribute("class", "edit");

   
    td11.setAttribute("style", "color: #26c406;");
    td11.style.fontWeight= "bold"

    td11.appendChild(br1);
    td11.appendChild(br2);
    td11.appendChild(tdbutton2);
    trow.appendChild(td11);
    tbody.appendChild(trow);
    tbody.appendChild(br);
}

//
function redirect(pjid){
  
  window.location.href = 'http://localhost:8080/paperInterface/binding/manage_Binding_Job/view_bindingjob_receive.html?pjid='+pjid;
}
//Send to print pop up form
function createForm(bindId){

let br1 = document.createElement("br");
let br2 = document.createElement("br");
let br3 = document.createElement("br");
let br4 = document.createElement("br");
let br5 = document.createElement("br");

var f = document.createElement('form');
f.setAttribute("class","formContainer");
f.setAttribute("id", "rcvfrm");

const h = document.createElement('h2');
h.textContent = "Received Data";

const h1 = document.createElement('h1');
h1.textContent = "Binding Job";

var label1 = document.createElement('label');
label1.innerHTML = "BIND ID: "+bindId;

const label2 = document.createElement('label');
label2.textContent = "Receive Quantity";

//create input element 1
var quan = document.createElement('input');
quan.type = "number";
quan.name = "quan";
quan.id = "quantity";
quan.placeholder = "Quantity"

//create a button
let insert = document.createElement('button');
insert.innerText = "Submit";
insert.type = "button";
insert.setAttribute("class",'save');
insert.setAttribute("id", "ins" + bindId);
insert.setAttribute("onCLick", "insertBindingReceive(this.id)");

//create a button
let close = document.createElement('button');
close.innerText = "close";
close.type = "button";
close.setAttribute("class",'delete');
close.setAttribute("onCLick", "closeForm()");

// add all elements to the form
f.appendChild(h1);
f.appendChild(h);
f.appendChild(label1);
f.appendChild(br1);
f.appendChild(br5);
f.appendChild(label2);
f.appendChild(quan);
f.appendChild(br2);
f.appendChild(insert);
f.appendChild(br3);
f.appendChild(br4);
f.appendChild(close);

// add the form inside the body
document.getElementById('popupForm').appendChild(f); //pure javascript
}

function openForm(bindId) {
    if(document.getElementById("rcvfrm") == null)
    {
      let bid;

      if(bindId[0] == 'r')
      {
        bid = bindId.substring(3);
      }
      else
      {
        bid = bindId
      }

      createForm(bid);
      document.getElementById("popupForm").style.display = "block";
    }
  }

function closeForm() {
  document.getElementById("popupForm").style.display = "none";
  document.getElementById("popupForm").removeChild(document.getElementById("rcvfrm"));
}

//receive from printing job
function insertBindingReceive(bindId){

  var bjid = bindId.substring(3)
  var qty =document.getElementById("quantity").value
  var receive = parseInt(document.getElementById("rec" + bjid).innerHTML);
  var remaining = parseInt(document.getElementById("rem" + bjid).innerHTML);
  
  res = validateValues(bjid);
  if(res == 0){
    closeForm();
    openForm(bid);
  }
  else
  {
  var myHeaders = new Headers();
  myHeaders.append("SOAPAction", "\"\"");
  myHeaders.append("Content-Type", "application/xml");

  var raw =`<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
    <Body>
        <insertReceiveFromBinding xmlns="http://manage_binding_job">
            <bindId>${bjid}</bindId>
            <receive>${qty}</receive>
        </insertReceiveFromBinding>
    </Body>
</Envelope>`

  var requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: raw,
    redirect: 'follow'
  };

  fetch("http://localhost:8080/paper/services/InsertReceiveFromBinding", requestOptions)
    .then(response => response.text())
    .then(result => {
      document.getElementById("rec" + bjid).innerHTML = parseInt(qty) + parseInt(receive);
      document.getElementById("rem" + bjid).innerHTML = remaining - qty;
      console.log(result);
      closeForm();
    })
    .catch(error => console.log('error', error));

}
}
function validateValues(bid) {
    var qty =document.getElementById("quantity").value
    var quan = parseInt(document.getElementById("rem" + bid).innerHTML);
    
    error = "Quantity exceed from Remaining Quantity!"
    if(qty > quan){
    alert(error); 
    return 0;
  }
  return 1;
}

</script>
</html>